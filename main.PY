# main.py â€” Uyku Kalitesi Analiz AracÄ± v3.1 (Yeni GÃ¼n Ekleme + Dashboard)
import tkinter as tk
from tkinter import filedialog, messagebox
from modules.analyzer import analyze_sleep_data
from modules.turtle_display import show_sleep_feedback
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg
import matplotlib.pyplot as plt
import pandas as pd
import os
from modules.simulation import sleep_simulation
from modules.predictor import predict_next_score


root = tk.Tk()
root.title("ðŸŒ™ Uyku Kalitesi Analiz ve GÃ¶rselleÅŸtirme AracÄ±")
root.state('zoomed')
root.configure(bg="#f0f4f7")

# Global deÄŸiÅŸkenler
df, summary = None, None
canvas_widget = None
current_file = None

# Ãœst BaÅŸlÄ±k
header = tk.Label(root, text="Uyku Kalitesi Analiz AracÄ± ðŸ˜´",
                  font=("Segoe UI", 20, "bold"), bg="#2e4053", fg="white", pady=10)
header.pack(fill="x")

# Ana Ã§erÃ§eve
frame = tk.Frame(root, bg="#f0f4f7", padx=30, pady=20)
frame.pack(fill="both", expand=True)

# Sol panel
left_panel = tk.Frame(frame, bg="#f0f4f7")
left_panel.pack(side="left", fill="y", padx=20)

result_text = tk.StringVar(value="HenÃ¼z veri yÃ¼klenmedi.")
btn_style = {
    "font": ("Segoe UI", 11, "bold"),
    "bg": "#3498db",
    "fg": "white",
    "activebackground": "#2e86c1",
    "activeforeground": "white",
    "relief": "flat",
    "width": 25,
    "pady": 8
}

def load_and_analyze():
    global df, summary, canvas_widget, current_file
    file_path = filedialog.askopenfilename(
        title="Uyku verisi CSV dosyasÄ±nÄ± seÃ§",
        filetypes=[("CSV files", "*.csv")]
    )
    if not file_path:
        return
    try:
        current_file = file_path
        df, summary = analyze_sleep_data(file_path)
        update_summary_text()
        messagebox.showinfo("BaÅŸarÄ±lÄ±", "Veri baÅŸarÄ±yla analiz edildi.")
        draw_graph()
    except Exception as e:
        messagebox.showerror("Hata", str(e))

def update_summary_text():
    global summary
    result_text.set(
        f"ðŸ“… En iyi gÃ¼n: {summary['en_iyi_gun']}\n"
        f"ðŸ˜´ Ortalama uyku: {summary['ortalama_uyku']} saat\n"
        f"ðŸ’¤ Derin uyku ort.: %{summary['ortalama_derin']}\n"
        f"ðŸ“Š Uyku puanÄ±: {summary['uyku_puani']}\n"
        f"ðŸ“‰ Sapma: {summary['std_sapma']}"
    )

def draw_graph():
    global df, summary, canvas_widget
    if canvas_widget:
        canvas_widget.get_tk_widget().destroy()

    plt.style.use('ggplot')
    fig, axs = plt.subplots(2, 1, figsize=(8, 5))

    axs[0].plot(df['Tarih'], df['Uyku_SÃ¼resi_Saat'], marker='o', linewidth=2.5, color='#1f77b4')
    axs[0].set_title('ðŸ›Œ GÃ¼nlÃ¼k Uyku SÃ¼resi (saat)', fontsize=12, weight='bold', color='#333')
    axs[0].axhline(df['Uyku_SÃ¼resi_Saat'].mean(), color='orange', linestyle='--', linewidth=1.5)
    axs[0].tick_params(axis='x', rotation=30)

    axs[1].bar(df['Tarih'], df['Derin_Uyku_YÃ¼zdesi'], color='#66b3ff', edgecolor='black', linewidth=0.7)
    axs[1].set_title('ðŸ’¤ Derin Uyku OranÄ± (%)', fontsize=12, weight='bold', color='#333')
    axs[1].tick_params(axis='x', rotation=30)

    fig.suptitle(f"ðŸŒ™ Genel Uyku PuanÄ±: {summary['uyku_puani']} / 100",
                 fontsize=13, weight='bold', color='#2e4053', y=0.98)
    plt.tight_layout(rect=[0, 0, 1, 0.92])

    canvas_widget = FigureCanvasTkAgg(fig, master=right_panel)
    canvas_widget.draw()
    canvas_widget.get_tk_widget().pack(fill="both", expand=True, pady=10)

def show_turtle():
    if summary is None:
        messagebox.showwarning("UyarÄ±", "Ã–nce veriyi analiz edin!")
        return
    show_sleep_feedback(summary['uyku_puani'])

def start_simulation():
    if summary is None:
        messagebox.showwarning("UyarÄ±", "Ã–nce veriyi analiz edin!")
        return
    sleep_simulation(summary['uyku_puani'])


# ðŸ†• Yeni GÃ¼n Ekle Penceresi
# --- ðŸ†• Yeni GÃ¼n Ekle (AkÄ±llÄ± Versiyon) ---
from datetime import datetime, timedelta
import pandas as pd
import os
from tkinter import messagebox

def open_add_entry_window():
    if not current_file:
        messagebox.showwarning("UyarÄ±", "Ã–nce bir CSV dosyasÄ± yÃ¼kleyin!")
        return

    add_win = tk.Toplevel(root)
    add_win.title("ðŸ†• Yeni GÃ¼n Ekle (AkÄ±llÄ± GiriÅŸ)")
    add_win.geometry("400x380")
    add_win.config(bg="#ecf0f1")

    tk.Label(add_win, text="Yeni Uyku Verisi Ekle", font=("Segoe UI", 14, "bold"), bg="#ecf0f1").pack(pady=10)

    entries = {}
    fields = ["Tarih (YYYY-MM-DD)", "Uyuma Saati (HH:MM)", "Uyanma Saati (HH:MM)"]
    for f in fields:
        tk.Label(add_win, text=f, bg="#ecf0f1", font=("Segoe UI", 10, "bold")).pack(pady=5)
        e = tk.Entry(add_win, width=25, font=("Consolas", 10))
        e.pack()
        entries[f] = e

    def save_entry():
        try:
            tarih = entries[fields[0]].get().strip()
            uyuma_saati = entries[fields[1]].get().strip()
            uyanma_saati = entries[fields[2]].get().strip()

            # ðŸ•’ Uyku sÃ¼resini hesapla
            fmt = "%H:%M"
            uyuma = datetime.strptime(uyuma_saati, fmt)
            uyanma = datetime.strptime(uyanma_saati, fmt)
            if uyanma < uyuma:
                uyanma += timedelta(days=1)
            uyku_suresi = round((uyanma - uyuma).total_seconds() / 3600, 2)

            # ðŸ’¡ Derin uyku yÃ¼zdesini otomatik tahmin et
            if uyku_suresi < 4:
                derin_yuzde = 10 + uyku_suresi * 2
            elif uyku_suresi <= 8:
                derin_yuzde = 20 + (uyku_suresi - 4) * 5
            else:
                derin_yuzde = 40 - (uyku_suresi - 8) * 3
            derin_yuzde = max(5, min(derin_yuzde, 45))

            new_data = {
                "Tarih": tarih,
                "Uyku_SÃ¼resi_Saat": uyku_suresi,
                "Derin_Uyku_YÃ¼zdesi": round(derin_yuzde, 1),
                "Uyuma_Saati": uyuma_saati,
                "Uyanma_Saati": uyanma_saati
            }

            # CSVâ€™ye ekle
            if os.path.exists(current_file):
                df_existing = pd.read_csv(current_file)
                df_updated = pd.concat([df_existing, pd.DataFrame([new_data])], ignore_index=True)
                df_updated.to_csv(current_file, index=False)
            else:
                pd.DataFrame([new_data]).to_csv(current_file, index=False)

            messagebox.showinfo("BaÅŸarÄ±lÄ±", f"Yeni veri eklendi!\nUyku SÃ¼resi: {uyku_suresi} saat\nDerin Uyku: %{round(derin_yuzde,1)}")
            add_win.destroy()

            # Yeniden analiz ve grafik gÃ¼ncelle
            global df, summary
            df, summary = analyze_sleep_data(current_file)
            update_summary_text()
            draw_graph()

        except Exception as e:
            messagebox.showerror("Hata", f"Veri eklenemedi: {str(e)}")




    tk.Button(
        add_win,
        text="ðŸ’¾ Kaydet",
        command=save_entry,
        bg="#27ae60",
        fg="white",
        font=("Segoe UI", 11, "bold"),
        relief="flat",
        pady=5,
        width=15
    ).pack(pady=15)

def show_prediction():
    if not current_file:
        messagebox.showwarning("UyarÄ±", "Ã–nce bir CSV yÃ¼kleyin!")
        return
    result = predict_next_score(current_file)
    if "Yeterli veri" in result or "hata" in result:
        messagebox.showwarning("Makine Ã–ÄŸrenmesi", result)
    else:
        messagebox.showinfo("Makine Ã–ÄŸrenmesi Tahmini", result)

# --- Butonlar ---
tk.Button(left_panel, text="ðŸ“‚ Veriyi YÃ¼kle ve Analiz Et", command=load_and_analyze, **btn_style).pack(pady=10)
tk.Button(left_panel, text="ðŸ“ˆ GrafiÄŸi GÃ¶ster", command=draw_graph, **btn_style).pack(pady=10)
tk.Button(left_panel, text="ðŸ†• Yeni GÃ¼n Ekle", command=open_add_entry_window, **btn_style).pack(pady=10)
tk.Button(left_panel, text="ðŸ¢ Turtle Ä°fadesi", command=show_turtle, **btn_style).pack(pady=10)
tk.Button(left_panel, text="ðŸŒ™ Uyku SimÃ¼lasyonu", command=start_simulation, **btn_style).pack(pady=10)
tk.Button(left_panel, text="ðŸ§  ML Tahmini", command=lambda: show_prediction(), **btn_style).pack(pady=10)


# SonuÃ§ etiketi
tk.Label(left_panel, textvariable=result_text, justify="left", bg="#f0f4f7", font=("Consolas", 10)).pack(pady=30)

# SaÄŸ panel (grafik alanÄ±)
right_panel = tk.Frame(frame, bg="white", relief="groove", bd=2)
right_panel.pack(side="right", fill="both", expand=True, padx=10)

footer = tk.Label(root, text="Â© 2025 Uyku Analiz Projesi | Profesyonel SÃ¼rÃ¼m",
                  bg="#2e4053", fg="white", font=("Segoe UI", 9))
footer.pack(fill="x", side="bottom")

import sys

def on_close():
    root.destroy()
    sys.exit()  # Python iÅŸlemini tamamen sonlandÄ±r

root.protocol("WM_DELETE_WINDOW", on_close)



root.mainloop()
